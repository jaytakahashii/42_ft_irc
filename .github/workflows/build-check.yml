name: Build Check with Valgrind

on:
  pull_request:
    branches: [ develop, main ]
  push:
    branches: [ develop, main ]

jobs:
  build-and-valgrind:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ft_irc

    steps:
      - name: ğŸ§¾ Checkout Repository
        uses: actions/checkout@v3

      - name: ğŸ›  Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential valgrind

      - name: âš™ï¸ Build with make pedant
        run: make pedant

      - name: ğŸš€ Run executable to check behavior
        run: |
          chmod +x ./ircserv
          ./ircserv 4242 password &
          sleep 1
          pkill ircserv || true

      - name: ğŸ§  Run Valgrind Memory Leak Check
        run: |
          chmod +x ./ircserv
          valgrind --leak-check=full --show-leak-kinds=all --error-exitcode=1 ./ircserv 4242 password </dev/null &
          sleep 2
          pkill ircserv || true

      - name: âœ… Done
        run: echo "Build and valgrind checks completed successfully."
